\section{Tailored QEMU} \label{sec:qemu}

In order to provide the server programs running inside the virtual machine the exact same 
inputs in the same order, we interpose on the \tapsend function in QEMU.

We modified the \taprecv function in QEMU to maintain a packet queue for each application 
that captures the corresponding outgoing packets. The network outputs are pushed into the 
queue and whenever the queue is full, a new hash value is calculated by 
$h_i=H(h_{i-1}\|H(queue))$ where $H()$ is a hash function and $||$ stands for concatenation. 
Such a computation links the hash value to all the previous network outpus. Then, after every 
\thashcomp hash values are generated, the latest one is passed to \smrsystem and the output 
checking protocol is invoked. The index of this hash value in the hash chain is 
consistent across replicas because each replica implements the same mechanism. 

Instead of checkpointing a server's process, we modified \smrsystem's checkpoint-recovery 
component to capture the entire execution state of the running VM. The checkpoint component is 
invoked every minute on a backup replica. After each checkpoint, the compressed file is dispatched 
to the other replicas. 
